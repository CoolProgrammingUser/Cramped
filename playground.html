<!doctype html>
<html>
	<head>
		<title>
			Cramped
		</title>
		<base target="_blank">
		<link rel="icon" href="images/favicon.ico">
		<script src="https://epicenterprograms.github.io/standards/behavior/general.js"></script>
		<!--
		<script src="file:///C:/Users/Robert/Documents/GitHub/standards/behavior/general.js"></script>
		-->
		<script src="behavior.js"></script>
		<script>
			var randomNoises;
			var blabbermouth = new S.Speaker();
			var oldCoords = { x: 0, y: 0 };
			var newCoords = { x: 0, y: 0 };
			var doodling = false;
			var canvas;
            var doodle;
            var box;

			S.listen("playRandomNoises", "click", function () {
				if (this.textContent.trim() == "Play random noises") {
					let noisemaker = new S.Sound();
					let playString;
					function addNote() {
						playString += ["a", "b", "c", "d", "e", "f", "g"][Math.floor(Math.random() * 7)] + (Math.floor(Math.random() * 2) + 4);
					}
					function maybeAddSlur() {
						if (Math.round(Math.random())) {
							playString += "s";
						} else {
							addNote();
						}
					}
					randomNoises = setInterval(function () {
						if (Math.round(Math.random())) {
							noisemaker.change("waveform", "sawtooth");
						} else {
							noisemaker.change("waveform", "square");
						}
						playString = "";
						addNote();
						maybeAddSlur();
						maybeAddSlur();
						addNote();
						noisemaker.play(playString, { noteLength: 150, attack: 1, decay: 1 });
					}, 610);
					this.textContent = "Stop random noises";
				} else {
					clearInterval(randomNoises);
					this.textContent = "Play random noises";
				}
			});

			S.listen("script", "dblclick", function () {
				this.value = "";
			});
			S.listen("speak", "click", function () {
				if (!blabbermouth.speaking) {
					blabbermouth.speak(S.getId("script").value);
				}
			});
			S.listen(["Enter"], "keydown", function () {
				if (S.getId("script") === document.activeElement) {
					S.getId("speak").click();
				}
			});
			S.listen("vodka", "click", function () {
				if (this.checked) {
					blabbermouth.rate = .3;
					blabbermouth.pitch = 2;
				} else {
					blabbermouth.rate = 1;
					blabbermouth.pitch = 1;
				}
			});

			S.listen("doodle", ["mousedown", "touchstart"], function (event) {
				doodling = true;
                oldCoords = { x: event.clientX - box.left, y: event.clientY - box.top };  // cursor position within the canvas
			});
			S.listen("doodle", ["mousemove", "touchmove"], function (event) {
				if (doodling) {
					newCoords = { x: event.clientX - box.left, y: event.clientY - box.top };
					doodle.strokeStyle = "#"
						+ ("0" + Math.round(newCoords.x / canvas.width * 255).toString(16)).slice(-2)
						+ ("0" + Math.round(newCoords.y / canvas.height * 255).toString(16)).slice(-2)
						+ ("0" + Math.round(255 - newCoords.x / canvas.width * 255).toString(16)).slice(-2);
					doodle.beginPath();
					doodle.moveTo(oldCoords.x, oldCoords.y);
					doodle.lineTo(newCoords.x, newCoords.y);
					doodle.stroke();
					oldCoords = newCoords;
				}
			});
			S.listen("doodle", ["mouseup", "touchend"], function () {
				doodling = false;
			});
			S.listen("clearDoodle", "click", function () {
				doodle.clearRect(0, 0, canvas.width, canvas.height);
			});

			S.onLoad(function () {
				S.makeToneGenerator(true);

				canvas = S.getId("doodle");
				doodle = canvas.getContext("2d");
				doodle.lineWidth = 3;
				box = canvas.getBoundingClientRect();
			});
		</script>
		<link rel="stylesheet" href="https://epicenterprograms.github.io/standards/formatting/foundation.css">
		<link rel="stylesheet" href="formatting.css">
		<style>
			canvas {
				background: white;
			}
		</style>
	</head>
	<body class="left-nav">
		<iframe class="left-nav" src="navigation.html"></iframe>
		<h1 class="main-title">
			Playground
		</h1>
		<main>
			<button id="playRandomNoises">
				Play random noises
			</button>
			<br>
			<br>
			<input type="text" id="script">
			<button id="speak">
				Speak
			</button>
			<input type="checkbox" id="vodka">
			<label for="vodka">
				Drunken puberty voice
			</label>
			<br>
			<br>
			<canvas width="500" height="300" id="doodle"></canvas>
			<br>
			<button id="clearDoodle">
				Clear drawing
			</button>
		</main>
	</body>
</html>
